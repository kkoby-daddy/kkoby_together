<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Together 놀이터</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
<!-- 폰트: Noto Sans KR + Tech 느낌의 Orbit -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Orbit&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-gradient: linear-gradient(135deg, #0f1115 0%, #1a1d26 100%);
    --sidebar-bg: rgba(22, 26, 34, 0.95);
    --main-bg: rgba(15, 17, 21, 0.6);
    --card-bg: rgba(35, 42, 54, 0.7);
    --border: 1px solid rgba(255, 255, 255, 0.1);
    --accent: #6aa0ff;
    --accent-glow: rgba(106, 160, 255, 0.3);
    --text-main: #e8ecf3;
    --text-sub: #8a9099;
    --ok: #35c759; --warn: #ffb300; --bad: #ff5171;
    --font-main: 'Noto Sans KR', sans-serif;
    --font-tech: 'Orbit', sans-serif;
    --radius: 16px;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; padding: 0;
    font-family: var(--font-main);
    background: var(--bg-gradient);
    color: var(--text-main);
    height: 100vh;
    overflow: hidden; 
  }

  /* 툴팁 */
  .floating-tip {
    position: fixed; z-index: 9999; max-width: 300px;
    background: #0b1320; color: #cfe1ff; border: 1px solid #2b3a55;
    border-radius: 10px; padding: 8px 12px; font-size: 12px; line-height: 1.4;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    pointer-events: none; opacity: 0; transform: translateY(5px);
    transition: opacity .15s ease, transform .15s ease;
  }
  .floating-tip.show { opacity: 1; transform: translateY(0); }

  /* 레이아웃 */
  .app-container { display: flex; height: 100%; width: 100vw; }

  /* 사이드바 */
  .sidebar {
    width: 400px; background: var(--sidebar-bg); backdrop-filter: blur(12px);
    border-right: var(--border); display: flex; flex-direction: column; z-index: 100;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .sidebar-header { padding: 20px; border-bottom: var(--border); flex-shrink: 0; }
  .brand { font-family: var(--font-tech); font-size: 18px; font-weight: 700; color: var(--accent); letter-spacing: 1px; }
  .ver { font-size: 11px; color: var(--text-sub); display: flex; justify-content: space-between; margin-top: 4px; }
  
  .search-area { padding: 15px 20px 5px; flex-shrink: 0; }
  .search-box input { width: 100%; background: rgba(0,0,0,0.3); border: var(--border); border-radius: 8px; padding: 12px; color: var(--text-main); outline: none; font-size: 16px; }

  .filter-chips { display: flex; flex-wrap: wrap; gap: 6px; padding: 0 20px 15px; flex-shrink: 0; }
  .chip { font-size: 12px; padding: 6px 10px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer; color: var(--text-sub); transition: 0.2s; border: 1px solid transparent; user-select: none; }
  .chip.active { background: var(--accent-glow); color: var(--accent); border-color: var(--accent); font-weight: 700; }
  .chip.label { background: transparent; color: var(--text-sub); cursor: default; font-weight: bold; padding-left: 0; }

  .pet-list { flex: 1; overflow-y: auto; padding: 0 10px 20px 20px; }
  .pet-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; margin-bottom: 8px; background: rgba(255,255,255,0.03); border-radius: 10px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
  .pet-item.selected { background: var(--accent-glow); border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
  .fav-icon { color: var(--text-sub); font-size: 18px; padding: 4px; }
  .fav-icon.active { color: #ffd700; }

  /* 메인 컨텐츠 */
  .main-content { flex: 1; display: flex; flex-direction: column; background: var(--main-bg); overflow-y: auto; position: relative; }
  .top-nav { display: flex; justify-content: flex-end; align-items: center; padding: 15px 20px; z-index: 20; min-height: 60px; position: absolute; top: 0; right: 0; left: 0; pointer-events: none; }
  .nav-controls { pointer-events: auto; display: flex; align-items: center; gap: 12px; background: rgba(15, 17, 21, 0.8); backdrop-filter: blur(5px); padding: 8px 16px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
  .menu-toggle { display: none; font-size: 24px; color: var(--text-main); cursor: pointer; }
  .admin-btn { font-size: 18px; color: var(--text-sub); cursor: pointer; background: transparent; border: none; padding: 4px; }

  .dashboard { padding: 70px 30px 40px; max-width: 1400px; margin: 0 auto; width: 100%; display: grid; grid-template-columns: 3fr 2fr; gap: 24px; }
  .panel { background: var(--card-bg); border-radius: var(--radius); border: var(--border); padding: 24px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.2); display: flex; flex-direction: column; min-height: 580px; }
  .panel h2 { margin: 0 0 20px; font-size: 18px; font-family: var(--font-tech); color: var(--accent); display: flex; align-items: center; gap: 8px; }
  .panel h2::before { content:''; display:block; width: 4px; height: 18px; background: var(--accent); border-radius: 2px; }

  /* 공지사항 유지 */
  .notice-panel { grid-column: 1 / -1; padding: 20px 24px; min-height: auto; }
  .notice-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .notice-title { font-size: 18px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
  .notice-title::before { content: 'ⓘ'; color: var(--accent); font-size: 20px; }
  .notice-content { padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 16px; line-height: 1.8; color: var(--text-sub); }

  /* 분석 HUD 링 복구 */
  .hud-rings { display: flex; justify-content: space-around; align-items: flex-end; padding: 10px 0 20px; }
  .ring-container { position: relative; width: 90px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .ring-svg { width: 70px; height: 70px; transform: rotate(-90deg); }
  .ring-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 8; }
  .ring-val { fill: none; stroke: var(--accent); stroke-width: 8; stroke-linecap: round; transition: stroke-dasharray 1s ease; }
  .ring-label { font-size: 11px; color: var(--text-sub); }
  .ring-text { position: absolute; top: 26px; left: 50%; transform: translateX(-50%); font-family: var(--font-tech); font-size: 15px; font-weight: 700; color: var(--text-main); }

  .stat-summary { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; }
  .sum-item { text-align: center; flex: 1; }
  .sum-label { font-size: 11px; color: var(--text-sub); display: block; margin-bottom: 4px;}
  .sum-val { font-size: 16px; font-weight: 700; color: var(--accent); font-family: var(--font-tech); }

  .rank8-card { background: rgba(53, 199, 89, 0.1); border: 1px solid var(--ok); border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .rank8-label { color: var(--ok); font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 6px; }
  .rank8-label::before { content:'★'; }
  .rank8-value { font-family: var(--font-tech); color: #fff; font-size: 18px; font-weight: 700; }

  /* 하단 알리미 패널 */
  .alarm-panel { grid-column: 1 / -1; min-height: auto; margin-top: 10px; }
  .alarm-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 15px; }
  .log-box { width: 100%; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px; font-family: monospace; font-size: 13px; color: #cfe1ff; min-height: 150px; max-height: 250px; overflow-y: auto; margin-top: 10px; border: 1px solid rgba(255,255,255,0.05); }
  .status-badge { font-size: 12px; padding: 4px 10px; border-radius: 999px; background: rgba(0,0,0,0.3); color: var(--text-sub); border: 1px solid transparent; }
  .status-badge.active { color: var(--ok); border-color: var(--ok); }
  
  .config-row { display: flex; gap: 20px; align-items: center; margin-bottom: 10px; font-size: 13px; }
  .config-row select { background: rgba(0,0,0,0.4); border: var(--border); color: #fff; padding: 4px 8px; border-radius: 4px; }

  /* 나머지 계산기 스타일 */
  .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 24px; }
  .stat-col label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 6px; text-align: center; }
  .stat-box { background: rgba(0,0,0,0.2); border: var(--border); border-radius: 8px; padding: 8px; text-align: center; }
  .stat-box input { width: 100%; background: transparent; border: none; color: var(--text-main); font-size: 16px; font-weight: 700; text-align: center; outline: none; font-family: var(--font-tech); padding: 0; }
  .stat-box.readonly { opacity: 0.6; background: rgba(0,0,0,0.4); }
  .input-group-title { font-size: 13px; color: var(--text-sub); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .input-group-title::after { content:''; height:1px; flex:1; background: rgba(255,255,255,0.1); }
  .stepper-btn { width: 100%; display: flex; gap: 4px; margin-top: 6px; }
  .s-btn { flex: 1; background: rgba(255,255,255,0.08); border: none; color: var(--text-sub); font-size: 14px; cursor: pointer; border-radius: 6px; padding: 12px 0; }
  .btn-main { flex: 1; padding: 16px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 16px; transition: 0.2s; }
  .btn-calc { background: var(--accent); color: #000; }
  .btn-reset { background: rgba(255,255,255,0.1); color: var(--text-main); }

  #toastWrap { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 8px; width: 90%; pointer-events: none; }
  .toast { background: rgba(30, 35, 45, 0.95); color: var(--text-main); padding: 12px 20px; border-radius: 12px; font-size: 14px; text-align: center; border: 1px solid var(--accent); opacity: 0; transition: 0.3s; }

  @media (max-width: 900px) {
    .dashboard { grid-template-columns: 1fr; padding: 60px 15px 15px; }
    .sidebar { position: fixed; left: 0; width: 85%; height: 100vh; transform: translateX(-100%); }
    .sidebar.active { transform: translateX(0); }
    .menu-toggle { display: block; }
  }
</style>
</head>
<body>

<div class="floating-tip" id="floatingTip"></div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="app-container">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="brand">꼬비아빠 놀이터</div>
      <div class="ver"><span>Date : 2026.02.20</span><span>Data by. 꼬비아빠</span></div>
    </div>
    <div class="search-area"><div class="search-box"><input type="text" id="petSearch" placeholder="페트 이름 검색..."></div></div>
    <div class="filter-chips" id="chosungTokens"></div>
    <div class="filter-chips" id="chosung"></div>
    <div style="padding: 0 20px 10px; display:flex; gap:10px; align-items:center;">
       <span style="font-size:11px; color:var(--text-sub);">즐겨찾기:</span><div id="favChips" style="display:flex; gap:5px; flex-wrap:wrap;"></div>
    </div>
    <div class="pet-list" id="petList"></div>
  </aside>

  <main class="main-content">
    <nav class="top-nav">
      <div class="nav-controls">
          <div class="menu-toggle" id="openSidebarBtn">☰</div>
          <button class="admin-btn" id="btnAdmin">★</button>
      </div>
    </nav>

    <div class="dashboard">
      <section class="panel notice-panel">
        <div class="notice-header"><div class="notice-title">SYSTEM NOTICE (StoneAge Together)</div></div>
        <div class="notice-content">
          - 입력된 페트 능력치에는 오타가 있을 수 있으니 페트 조회 시 게임 내 페트의 초기치 및 성장률이 같은지 확인하세요.<br>
          - 오타가 있다면 말씀 부탁드리며, 해당 계산기는 재미로만 봐주시길 바랍니다. <br>
          <span style="color:var(--accent)">- 특이사항 : 꼬비 / 남아 / 푸들(갈색) / 20.03.24 출생 / 중성화 O</span>
        </div>
      </section>

      <section class="panel">
        <h2><span id="selectedPetTitle">페트를 선택해주세요</span></h2>
        <div class="input-group-title">S급 기준 (초기치 / 성장률)</div>
        <div class="stat-grid">
          <div class="stat-col"><label>내구력</label><div class="stat-box readonly"><input type="text" id="s0_hp" readonly></div><div class="stat-box readonly" style="margin-top:6px"><input type="text" id="sg_hp" readonly></div></div>
          <div class="stat-col"><label>공격력</label><div class="stat-box readonly"><input type="text" id="s0_atk" readonly></div><div class="stat-box readonly" style="margin-top:6px"><input type="text" id="sg_atk" readonly></div></div>
          <div class="stat-col"><label>방어력</label><div class="stat-box readonly"><input type="text" id="s0_def" readonly></div><div class="stat-box readonly" style="margin-top:6px"><input type="text" id="sg_def" readonly></div></div>
          <div class="stat-col"><label>순발력</label><div class="stat-box readonly"><input type="text" id="s0_agi" readonly></div><div class="stat-box readonly" style="margin-top:6px"><input type="text" id="sg_agi" readonly></div></div>
        </div>
        <div class="input-group-title" style="margin-top:20px; color:var(--accent);">Lv.1 페트 능력치 입력</div>
        <div class="stat-grid">
          <div class="stat-col"><label>내구력</label><div class="stat-box"><input type="number" id="obs_hp" placeholder="0"></div><div class="stepper-btn"><button class="s-btn" data-target="obs_hp" data-delta="-1">-1</button><button class="s-btn" data-target="obs_hp" data-delta="1">+1</button></div></div>
          <div class="stat-col"><label>공격력</label><div class="stat-box"><input type="number" id="obs_atk" placeholder="0"></div><div class="stepper-btn"><button class="s-btn" data-target="obs_atk" data-delta="-1">-1</button><button class="s-btn" data-target="obs_atk" data-delta="1">+1</button></div></div>
          <div class="stat-col"><label>방어력</label><div class="stat-box"><input type="number" id="obs_def" placeholder="0"></div><div class="stepper-btn"><button class="s-btn" data-target="obs_def" data-delta="-1">-1</button><button class="s-btn" data-target="obs_def" data-delta="1">+1</button></div></div>
          <div class="stat-col"><label>순발력</label><div class="stat-box"><input type="number" id="obs_agi" placeholder="0"></div><div class="stepper-btn"><button class="s-btn" data-target="obs_agi" data-delta="-1">-1</button><button class="s-btn" data-target="obs_agi" data-delta="1">+1</button></div></div>
        </div>
        <div class="action-btns">
          <button class="btn-main btn-reset" id="btnReset">리셋</button>
          <button class="btn-main btn-calc" id="btnCalc">분석 시작</button>
        </div>
      </section>

      <section class="panel result-panel">
        <h2>ANALYSIS HUD</h2>
        <div class="hud-rings">
          <div class="ring-container">
            <svg class="ring-svg" viewBox="0 0 36 36"><path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /><path id="ringSuccess" class="ring-val" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /></svg>
            <div class="ring-text" id="kpiSuccess">0%</div><span class="ring-label">8등급 확률</span>
          </div>
          <div class="ring-container">
            <svg class="ring-svg" viewBox="0 0 36 36"><path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /><path id="ringTries" class="ring-val" style="stroke:#ffb300" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /></svg>
            <div class="ring-text" id="kpiTries">-</div><span class="ring-label">시도 횟수</span>
          </div>
        </div>
        <div class="stat-summary">
          <div class="sum-item"><span class="sum-label">출현 확률</span><span class="sum-val" id="kpiAppear">-</span></div>
          <div class="sum-item"><span class="sum-label">경우의 수</span><span class="sum-val" id="totMatches">-</span></div>
          <div class="sum-item"><span class="sum-label">8등급 매칭</span><span class="sum-val" id="rank8Matches">-</span></div>
        </div>
        <div id="dist" style="margin-top:20px;"></div>
      </section>

      <!-- 펫 가방 알리미 통합 -->
      <section class="panel alarm-panel">
        <h2>PET BAG ALARM (가방 [0]칸 감지)</h2>
        <div class="config-row">
          <label>인코딩: <select id="phEncoding"><option value="auto">자동</option><option value="cp949">EUC-KR</option><option value="utf8">UTF-8</option></select></label>
          <label><input type="checkbox" id="phSoundEnable" checked> 알림음</label>
          <div style="flex:1; display:flex; align-items:center; gap:8px;">
            <span>볼륨</span><input type="range" id="phSoundVol" min="0" max="100" value="70" style="flex:1;">
          </div>
        </div>
        <div class="alarm-controls">
          <button class="btn-sm primary" id="phPickDirBtn">로그 폴더 선택</button>
          <button class="btn-sm" id="phNotifyBtn">알림 허용</button>
          <button class="btn-sm" id="phStopBtn">중지</button>
          <div class="status-badge" id="phStatus">대기...</div>
          <div style="font-size: 11px; color: var(--text-sub);" id="phDirInfo">-</div>
        </div>
        <div class="log-box" id="phLogBox">폴더를 선택하면 로그가 표시됩니다.</div>
      </section>
    </div>
  </main>
</div>

<div id="toastWrap"></div>

<script>
/* ========= 데이터 및 계산 엔진 (원본 복구) ========= */
const REMOTE_PETS = `https://raw.githubusercontent.com/kkoby-daddy/kkoby-daddy.github.io/kkoby_together/data/pets.json`;
const LOCAL_PETS = "data/pets.json";
const R8_JSON_CANDIDATES = ["data/guaranteed_rank8.full.json", "data/guaranteed_rank8.min.json"];
const TOTAL = 178750;
let GLOBAL_TABLE = {}, ALL_NAMES = [], R8MAP = {}, FAVS = [];

function showToast(msg){
  const wrap = document.getElementById("toastWrap");
  const t = document.createElement("div"); t.className = "toast"; t.textContent = msg;
  wrap.appendChild(t);
  void t.offsetWidth; t.style.opacity = '1';
  setTimeout(()=>{ t.style.opacity = '0'; setTimeout(()=>t.remove(), 300); }, 2000);
}

async function loadGlobalTable(){
  try {
    const obj = await fetchJSON(REMOTE_PETS);
    GLOBAL_TABLE = obj;
  } catch {
    try { const obj = await fetchJSON(LOCAL_PETS); GLOBAL_TABLE = obj; } catch { GLOBAL_TABLE = JSON.parse(localStorage.getItem("TogetherPetTable_cache")||"{}"); }
  }
  ALL_NAMES = Object.keys(GLOBAL_TABLE).sort((a,b)=>a.localeCompare(b,'ko'));
  FAVS = JSON.parse(localStorage.getItem("pet_favs_v1")||"[]").filter(n => GLOBAL_TABLE[n]);
  renderFavChips(); renderPetList();
}
async function fetchJSON(url){ return fetch(url+`?v=${Date.now()}`,{cache:"no-store"}).then(r=>{ if(!r.ok) throw 0; return r.json();}); }

/* 분석 엔진 복구 */
function solveUFromSG_JJYAL(SG, e){
  try{
    Decimal.set({ precision:50, rounding: Decimal.ROUND_HALF_UP });
    const eD = new Decimal(e), f = eD.div(10000);
    const d = new Decimal(SG.agi).times(10000).div(eD).minus(2.5).round();
    const rhs1 = new Decimal(SG.hp).minus( d.plus(2.5).times(f) ).div(f);
    const rhs2 = new Decimal(SG.atk).minus( d.plus(2.5).times(f).times(0.05) ).div(f);
    const rhs3 = new Decimal(SG.def).minus( d.plus(2.5).times(f).times(0.05) ).div(f);
    let A = [[ new Decimal(4),new Decimal(1),new Decimal(1), rhs1 ],[ new Decimal(0.1), new Decimal(1), new Decimal(0.1), rhs2 ],[ new Decimal(0.1), new Decimal(0.1), new Decimal(1), rhs3 ]];
    for(let i=0;i<3;i++){
      let mr=i; let mv=A[i][i].abs();
      for(let j=i+1;j<3;j++) if(A[j][i].abs().gt(mv)){mr=j; mv=A[j][i].abs();}
      let t=A[i]; A[i]=A[mr]; A[mr]=t;
      let piv=A[i][i]; for(let j=i;j<4;j++) A[i][j]=A[i][j].div(piv);
      for(let k=0;k<3;k++) if(k!==i){ let fac=A[k][i]; for(let j=i;j<4;j++) A[k][j]=A[k][j].minus(fac.times(A[i][j])); }
    }
    return { u:{hp:+A[0][3].minus(2.5).round(), atk:+A[1][3].minus(2.5).round(), def:+A[2][3].minus(2.5).round(), agi:+d}, e };
  }catch(e){ return null; }
}

function inferKU_JJYAL(S0, SG){
  const S0int = S0.map(Math.floor); let best=null;
  for(let e=435; e<=575; e+=5){
    const sol = solveUFromSG_JJYAL(SG, e); if(!sol) continue;
    for(let k=10; k<=100; k++){
      const fac = k/100, v = [sol.u.hp, sol.u.atk, sol.u.def, sol.u.agi].map(x=>(x+2.5)*fac);
      const s = [Math.floor(v[0]*4+v[1]+v[2]+v[3]), Math.floor(v[0]*0.1+v[1]+v[2]*0.1+v[3]*0.05), Math.floor(v[0]*0.1+v[1]*0.1+v[2]+v[3]*0.05), Math.floor(v[3])];
      const l1 = s.reduce((a,c,i)=>a+Math.abs(c-S0int[i]),0);
      if(l1===0) return {k, u:sol.u};
      if(!best || l1<best.l1) best={k, u:sol.u, l1};
    }
  }
  return best;
}

function enumerate_jjyal(pku, obs){
  const k = new Decimal(pku.k), fac = k.div(100), u = pku.u;
  let matches = 0, r8 = 0, dist = {};
  for(let ar=-2; ar<=2; ar++) for(let dr=-2; dr<=2; dr++) for(let gr=-2; gr<=2; gr++) for(let hr=-2; hr<=2; hr++){
    for(let ab=0; ab<=10; ab++) for(let db=0; db<=10; db++) for(let gb=0; gb<=10; gb++){
      let hb = 10 - ab - db - gb; if(hb<0 || hb>10) continue;
      let iH = new Decimal(u.hp+hr+hb).times(fac), iA = new Decimal(u.atk+ar+ab).times(fac), iD = new Decimal(u.def+dr+db).times(fac), iG = new Decimal(u.agi+gr+gb).times(fac);
      if(iG.floor().toNumber() !== obs[3]) continue;
      if(iH.times(4).plus(iA).plus(iD).plus(iG).floor().toNumber() !== obs[0]) continue;
      if(iH.times(0.1).plus(iA).plus(iD.times(0.1)).plus(iG.times(0.05)).floor().toNumber() !== obs[1]) continue;
      if(iH.times(0.1).plus(iA.times(0.1)).plus(iD).plus(iG.times(0.05)).floor().toNumber() !== obs[2]) continue;
      matches++; let r = ar+dr+gr+hr; dist[r] = (dist[r]||0)+1; if(r===8) r8++;
    }
  }
  return {matches, rank8:r8, dist};
}

/* ========= 가방 알리미 로직 (요청 반영) ========= */
(function(){
  const POLL_MS = 1200;
  const BAG_COOLDOWN_MS = 60000;
  const ALARM_SOUND_URL = "sam_02.wav"; 
  let dirHandle = null, currentFileName = null, prevLen = 0, recentLines = [], bagFullState = false;
  let lastBagAlertAt = 0, pollInterval = null, primed = false, _beepAudio = null, _unlocked = false;

  const el = (id) => document.getElementById(id);

  function getAudio() {
    if (!_beepAudio) { _beepAudio = new Audio(ALARM_SOUND_URL); _beepAudio.preload = "auto"; }
    return _beepAudio;
  }
  function unlock() { if(_unlocked) return; getAudio().muted = true; getAudio().play().then(()=>{ getAudio().pause(); getAudio().muted=false; _unlocked=true; }); }
  function playAlarm() { if(!el('phSoundEnable').checked) return; const a = getAudio(); a.volume = el('phSoundVol').value / 100; a.currentTime = 0; a.play(); }
  function notify(title, body) { if ("Notification" in window && Notification.permission === "granted") new Notification(title, { body }); playAlarm(); showToast(body); }

  async function poll() {
    if (!dirHandle) return;
    try {
      let latest = null;
      for await (const [name, handle] of dirHandle.entries()) {
        if (handle.kind === "file" && /^\d{6}\.txt$/i.test(name)) if (!latest || name > latest.name) latest = { name, handle };
      }
      if (!latest) return;
      if (currentFileName !== latest.name) { currentFileName = latest.name; prevLen = 0; recentLines = []; bagFullState = false; primed = false; el('phCurrentFile').textContent = latest.name; }

      const file = await latest.handle.getFile();
      const buf = await file.arrayBuffer();
      const enc = el('phEncoding').value === "auto" ? "euc-kr" : (el('phEncoding').value === "utf8" ? "utf-8" : "euc-kr");
      const text = new TextDecoder(enc).decode(buf);

      if (!primed) { recentLines = text.split(/\r?\n/).slice(-20); prevLen = text.length; primed = true; return; }

      const newPart = text.slice(prevLen);
      if (newPart) {
        prevLen = text.length;
        const newLines = newPart.split(/\r?\n/).filter(x => x.length);
        for (const line of newLines) {
          recentLines.push(line); if (recentLines.length > 50) recentLines.shift();
          if (line.includes("[0]칸")) {
            const now = Date.now();
            if (!bagFullState && (now - lastBagAlertAt > BAG_COOLDOWN_MS)) { bagFullState = true; lastBagAlertAt = now; notify("⚠️ 가방 가득 참", "남은 가방이 [0]칸입니다!"); }
          } else if (line.match(/\[[1-9]\d*\]칸/)) { bagFullState = false; }
        }
        el('phLogBox').textContent = recentLines.join("\n");
        el('phLogBox').scrollTop = el('phLogBox').scrollHeight;
      }
    } catch (e) {}
  }

  el('phPickDirBtn').onclick = async () => { unlock(); try { dirHandle = await window.showDirectoryPicker(); el('phStatus').textContent="감지 중"; el('phStatus').classList.add('active'); el('phDirInfo').textContent="연결됨"; if(pollInterval) clearInterval(pollInterval); pollInterval = setInterval(poll, POLL_MS); } catch(e){} };
  el('phNotifyBtn').onclick = async () => { unlock(); Notification.requestPermission(); };
  el('phStopBtn').onclick = () => { if(pollInterval) clearInterval(pollInterval); dirHandle=null; el('phStatus').textContent="대기"; el('phStatus').classList.remove('active'); };
})();

/* ========= UI 상호작용 (원본 로직) ========= */
function selectPetName(n){
  selectedName=n; const row=GLOBAL_TABLE[n]||null;
  document.getElementById('selectedPetTitle').textContent = n || "페트를 선택해주세요";
  if(row){
    ['hp','atk','def','agi'].forEach(s => {
      document.getElementById('s0_'+s).value = Number(row.s0[s]).toFixed(2);
      document.getElementById('sg_'+s).value = Number(row.sg[s]).toFixed(2);
      document.getElementById('obs_'+s).value = Math.floor(row.s0[s]);
    });
  }
  resetHUD();
}

function resetHUD() {
    document.getElementById('kpiSuccess').textContent = "0%"; document.getElementById('ringSuccess').style.strokeDasharray = "0, 100";
    document.getElementById('kpiTries').textContent = "-"; document.getElementById('ringTries').style.strokeDasharray = "0, 100";
    document.getElementById('kpiAppear').textContent = "-"; document.getElementById('totMatches').textContent = "-"; document.getElementById('rank8Matches').textContent = "-";
    document.getElementById('dist').innerHTML = "";
}

document.getElementById('btnCalc').onclick = () => {
  if(!selectedName) return showToast("페트를 선택하세요!");
  const obs = ['hp','atk','def','agi'].map(s => parseInt(document.getElementById('obs_'+s).value));
  const row = GLOBAL_TABLE[selectedName];
  const fit = inferKU_JJYAL([row.s0.hp, row.s0.atk, row.s0.def, row.s0.agi], row.sg);
  if(!fit) return showToast("추정 실패");
  renderResult(enumerate_jjyal({k:fit.k, u:fit.u}, obs));
};

function renderResult(res) {
    const m = res.matches, r8 = res.rank8, sPct = m ? (r8/m*100) : 0, tries = sPct > 0 ? (100/sPct) : Infinity;
    document.getElementById('ringSuccess').style.strokeDasharray = `${sPct.toFixed(1)}, 100`;
    document.getElementById('kpiSuccess').textContent = sPct.toFixed(2) + "%";
    document.getElementById('kpiTries').textContent = isFinite(tries) ? Math.round(tries) : "∞";
    document.getElementById('kpiAppear').textContent = (m/TOTAL*100).toFixed(4) + "%";
    document.getElementById('totMatches').textContent = m.toLocaleString();
    document.getElementById('rank8Matches').textContent = r8.toLocaleString();

    let html = `<div class="rank8-card"><div class="rank8-label">8등급</div><div class="rank8-value">${r8.toLocaleString()}개 (${sPct.toFixed(2)}%)</div></div>`;
    document.getElementById('dist').innerHTML = html;
}

/* 초성 검색 등 나머지 코드 생략 (기존 유지) */
const CHO_BUTTONS = ['ㄱ','ㄴ','ㄷ','ㄹ','ㅁ','ㅂ','ㅅ','ㅇ','ㅈ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
CHO_BUTTONS.forEach(c => {
  const chip = document.createElement('div'); chip.className = 'chip'; chip.textContent = c;
  chip.onclick = () => { currentChosung += c; renderPetList(); renderChosungTokens(); };
  document.getElementById('chosung').appendChild(chip);
});

function renderChosungTokens(){
  const box = document.getElementById('chosungTokens'); box.innerHTML = "";
  if(!currentChosung) return;
  [...currentChosung].forEach(ch => { const c = document.createElement('div'); c.className='chip active'; c.textContent=ch; box.appendChild(c); });
  const clr = document.createElement('div'); clr.className='chip'; clr.textContent='↺'; clr.onclick=()=>{currentChosung="";renderPetList();renderChosungTokens();}; box.appendChild(clr);
}

function getChosung(str){ let out=""; for(const ch of str){ const code = ch.charCodeAt(0); if(code<0xAC00 || code>0xD7A3){ out+=ch; continue; } const idx = Math.floor((code - 0xAC00) / 588); out += CHO_SIMPLE(CHO_CODE[idx]); } return out; }
function isFav(n){ return FAVS.includes(n); }
function toggleFav(n){ if(isFav(n)) FAVS=FAVS.filter(x=>x!==n); else FAVS.push(n); localStorage.setItem("pet_favs_v1", JSON.stringify(FAVS)); renderFavChips(); renderPetList(); }
function renderFavChips(){ const b = document.getElementById('favChips'); b.innerHTML=""; FAVS.forEach(n=>{ const c=document.createElement('div'); c.className='chip active'; c.textContent=n; c.onclick=()=>selectPetName(n); b.appendChild(c); }); }

function renderPetList() {
  const kw = document.getElementById('petSearch').value.trim();
  const list = ALL_NAMES.filter(n => (kw ? n.includes(kw) : true) && (currentChosung ? getChosung(n).startsWith(currentChosung) : true));
  const box = document.getElementById('petList'); box.innerHTML = "";
  list.forEach(n => {
    const item = document.createElement('div'); item.className = 'pet-item' + (selectedName === n ? ' selected' : '');
    item.innerHTML = `<span class="pet-name">${n}</span><div class="pet-right"><span class="fav-icon ${isFav(n)?'active':''}">★</span></div>`;
    item.querySelector('.fav-icon').onclick = (e) => { e.stopPropagation(); toggleFav(n); };
    item.onclick = () => selectPetName(n);
    box.appendChild(item);
  });
}

document.getElementById('petSearch').oninput = renderPetList;
document.getElementById('btnReset').onclick = () => { selectPetName(""); resetHUD(); };
document.querySelectorAll('.s-btn').forEach(b => b.onclick = () => { const i = document.getElementById(b.dataset.target); i.value = parseInt(i.value||0) + parseInt(b.dataset.delta); });

const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('sidebarOverlay');
document.getElementById('openSidebarBtn').onclick = () => { sidebar.classList.add('active'); overlay.classList.add('active'); };
overlay.onclick = () => { sidebar.classList.remove('active'); overlay.classList.remove('active'); };

loadGlobalTable();
</script>
</body>
</html>
