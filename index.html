<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Together ë†€ì´í„° - ê¼¬ë¹„ì•„ë¹ </title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
<!-- í°íŠ¸: Noto Sans KR + Tech ëŠë‚Œì˜ Orbit -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Orbit&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-gradient: linear-gradient(135deg, #0f1115 0%, #1a1d26 100%);
    --sidebar-bg: rgba(22, 26, 34, 0.95);
    --main-bg: rgba(15, 17, 21, 0.6);
    --card-bg: rgba(35, 42, 54, 0.7);
    --border: 1px solid rgba(255, 255, 255, 0.1);
    --accent: #6aa0ff;
    --accent-glow: rgba(106, 160, 255, 0.3);
    --text-main: #e8ecf3;
    --text-sub: #8a9099;
    --ok: #35c759; --warn: #ffb300; --bad: #ff5171;
    --font-main: 'Noto Sans KR', sans-serif;
    --font-tech: 'Orbit', sans-serif;
    --radius: 16px;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; padding: 0;
    font-family: var(--font-main);
    background: var(--bg-gradient);
    color: var(--text-main);
    height: 100vh;
    overflow: hidden; 
  }

  /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
  .floating-tip {
    position: fixed; z-index: 9999; max-width: 300px;
    background: #0b1320; color: #cfe1ff; border: 1px solid #2b3a55;
    border-radius: 10px; padding: 8px 12px; font-size: 12px; line-height: 1.4;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    pointer-events: none; white-space: normal; word-break: keep-all;
    opacity: 0; transform: translateY(5px);
    transition: opacity .15s ease, transform .15s ease;
  }
  .floating-tip.show { opacity: 1; transform: translateY(0); }

  /* ë ˆì´ì•„ì›ƒ */
  .app-container { display: flex; height: 100%; width: 100vw; }

  /* ì‚¬ì´ë“œë°” */
  .sidebar {
    width: 400px;
    background: var(--sidebar-bg);
    backdrop-filter: blur(12px);
    border-right: var(--border);
    display: flex; flex-direction: column;
    z-index: 100;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .sidebar-header { padding: 20px; border-bottom: var(--border); flex-shrink: 0; }
  .brand-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .brand { font-family: var(--font-tech); font-size: 18px; font-weight: 700; color: var(--accent); letter-spacing: 1px; }
  .ver { font-size: 11px; color: var(--text-sub); display: flex; justify-content: space-between; margin-top: 4px; }
  
  .search-area { padding: 15px 20px 5px; flex-shrink: 0; }
  .search-box { position: relative; margin-bottom: 10px; }
  .search-box input {
    width: 100%; background: rgba(0,0,0,0.3); border: var(--border);
    border-radius: 8px; padding: 12px; color: var(--text-main);
    outline: none; font-size: 16px;
  }
  .search-box input:focus { border-color: var(--accent); }

  .filter-chips { display: flex; flex-wrap: wrap; gap: 6px; padding: 0 20px 15px; flex-shrink: 0; }
  .chip {
    font-size: 12px; padding: 6px 10px; background: rgba(255,255,255,0.05);
    border-radius: 6px; cursor: pointer; color: var(--text-sub);
    transition: 0.2s; border: 1px solid transparent; user-select: none;
  }
  .chip:hover { background: rgba(255,255,255,0.1); }
  .chip.active { background: var(--accent-glow); color: var(--accent); border-color: var(--accent); font-weight: 700; }
  .chip.label { background: transparent; color: var(--text-sub); border-color: transparent; cursor: default; font-weight: bold; padding-left: 0; }

  .pet-list { flex: 1; overflow-y: auto; padding: 0 10px 20px 20px; -webkit-overflow-scrolling: touch; }
  .pet-list::-webkit-scrollbar { width: 6px; }
  .pet-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

  .pet-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 16px; margin-bottom: 8px;
    background: rgba(255,255,255,0.03); border-radius: 10px;
    cursor: pointer; border: 1px solid transparent; transition: all 0.2s;
  }
  .pet-item.selected { background: var(--accent-glow); border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
  .pet-name { font-weight: 500; font-size: 15px; }
  .pet-right { display: flex; align-items: center; gap: 8px; }
  .badge-r8 { font-size: 10px; padding: 3px 6px; background: rgba(192, 132, 252, 0.15); color: #e879f9; border: 1px solid #c084fc; border-radius: 4px; font-weight: 700; cursor: help; }
  .fav-icon { color: var(--text-sub); font-size: 18px; padding: 4px; }
  .fav-icon.active { color: #ffd700; text-shadow: 0 0 8px rgba(255, 215, 0, 0.5); }

  /* ë©”ì¸ ì»¨í…ì¸  */
  .main-content {
    flex: 1; display: flex; flex-direction: column;
    background: var(--main-bg); overflow-y: auto; position: relative;
    -webkit-overflow-scrolling: touch;
  }
  
  .top-nav {
    display: flex; justify-content: flex-end; align-items: center;
    padding: 15px 20px; z-index: 20; min-height: 60px;
    position: absolute; top: 0; right: 0; left: 0; pointer-events: none;
  }
  .nav-controls {
    pointer-events: auto; display: flex; align-items: center; gap: 12px;
    background: rgba(15, 17, 21, 0.8); backdrop-filter: blur(5px);
    padding: 8px 16px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
  }
  .menu-toggle { display: none; font-size: 24px; color: var(--text-main); cursor: pointer; }
  .admin-btn { font-size: 18px; color: var(--text-sub); cursor: pointer; background: transparent; border: none; padding: 4px; transition: 0.2s; }
  .admin-btn:hover { color: var(--accent); transform: scale(1.1); }

  .dashboard {
    padding: 70px 30px 40px; max-width: 1400px; margin: 0 auto;
    width: 100%; display: grid; grid-template-columns: 3fr 2fr; gap: 24px;
    align-items: flex-start;
  }

  .panel {
    background: var(--card-bg); border-radius: var(--radius);
    border: var(--border); padding: 24px; backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.2); display: flex; flex-direction: column;
  }
  .panel h2 {
    margin: 0 0 20px; font-size: 18px; font-family: var(--font-tech);
    color: var(--accent); display: flex; align-items: center; gap: 8px;
  }
  .panel h2::before { content:''; display:block; width: 4px; height: 18px; background: var(--accent); border-radius: 2px; }

  .notice-panel { grid-column: 1 / -1; padding: 20px 24px; }
  .notice-content { border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; font-size: 15px; line-height: 1.8; color: var(--text-sub); }

  /* ì…ë ¥ ì˜ì—­ */
  .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 24px; }
  .stat-col label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 6px; text-align: center; }
  .stat-box { background: rgba(0,0,0,0.2); border: var(--border); border-radius: 8px; padding: 8px; text-align: center; }
  .stat-box input { width: 100%; background: transparent; border: none; color: var(--text-main); font-size: 16px; font-weight: 700; text-align: center; outline: none; font-family: var(--font-tech); }
  .stat-box.readonly { opacity: 0.6; }
  .input-group-title { font-size: 13px; color: var(--text-sub); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .input-group-title::after { content:''; height:1px; flex:1; background: rgba(255,255,255,0.1); }
  .s-btn { flex: 1; background: rgba(255,255,255,0.08); border: none; color: var(--text-sub); font-size: 14px; cursor: pointer; border-radius: 6px; padding: 12px 0; }

  .action-btns { display: flex; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); }
  .btn-main { flex: 1; padding: 16px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 16px; transition: 0.2s; }
  .btn-calc { background: var(--accent); color: #000; }
  .btn-reset { background: rgba(255,255,255,0.1); color: var(--text-main); }

  /* HUD ê²°ê³¼ */
  .hud-rings { display: flex; justify-content: space-around; align-items: flex-end; padding: 10px 0 20px; }
  .ring-container { position: relative; width: 90px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .ring-svg { width: 70px; height: 70px; transform: rotate(-90deg); }
  .ring-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 8; }
  .ring-val { fill: none; stroke: var(--accent); stroke-width: 8; stroke-linecap: round; transition: stroke-dasharray 1s ease; }
  .ring-text { position: absolute; top: 26px; left: 50%; transform: translateX(-50%); font-family: var(--font-tech); font-size: 15px; font-weight: 700; }

  .stat-summary { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; }
  .sum-item { text-align: center; flex: 1; }
  .sum-label { font-size: 11px; color: var(--text-sub); display: block; margin-bottom: 4px;}
  .sum-val { font-size: 16px; font-weight: 700; color: var(--accent); font-family: var(--font-tech); }

  /* í˜íŠ¸ì¡ì´ ì•Œë¦¼ íŒ¨ë„ */
  .monitor-status { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 13px; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
  .status-dot.active { background: var(--ok); box-shadow: 0 0 8px var(--ok); }
  
  .volume-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 0 5px; }
  .volume-slider { flex: 1; accent-color: var(--accent); cursor: pointer; height: 4px; }
  
  .log-viewer {
    background: rgba(0,0,0,0.4); border-radius: 12px; height: 200px; overflow-y: auto;
    padding: 12px; font-family: 'Courier New', Courier, monospace; font-size: 12px; line-height: 1.5; color: #a5b4fc;
    border: 1px solid rgba(255,255,255,0.05); scroll-behavior: smooth;
  }
  .log-line { margin-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.02); }
  .log-line.alert { color: var(--bad); font-weight: 700; background: rgba(255, 81, 113, 0.1); border-radius: 4px; padding: 2px 4px; }
  .monitor-btns { display: flex; gap: 8px; margin-top: 15px; }
  .btn-sm { padding: 10px; font-size: 12px; border-radius: 8px; flex: 1; }

  /* í…Œì´ë¸” & ìƒì„¸ */
  .rank8-card { background: rgba(53, 199, 89, 0.1); border: 1px solid var(--ok); border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .detail-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
  .detail-table th { text-align: left; color: var(--text-sub); padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .detail-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }

  @media (max-width: 900px) {
    body { height: auto; overflow: auto; }
    .app-container { flex-direction: column; }
    .sidebar { position: fixed; inset: 0 auto 0 0; width: 85%; transform: translateX(-100%); }
    .sidebar.active { transform: translateX(0); }
    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; display: none; }
    .sidebar-overlay.active { display: block; }
    .dashboard { grid-template-columns: 1fr; padding: 60px 15px; }
    .menu-toggle { display: block; }
    .top-nav { position: fixed; background: rgba(15,17,21,0.95); pointer-events: auto; }
  }

  #toastWrap { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; pointer-events: none; }
  .toast { background: #1e232d; color: #fff; padding: 12px 20px; border-radius: 12px; font-size: 14px; text-align: center; border: 1px solid var(--accent); opacity: 0; transition: 0.3s; margin-top: 8px; }
</style>
</head>
<body>

<div class="floating-tip" id="floatingTip"></div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="app-container">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="brand-row"><div class="brand">ê¼¬ë¹„ì•„ë¹  ë†€ì´í„°</div><div class="menu-toggle" id="closeSidebarBtn">âœ•</div></div>
      <div class="ver"><span>Date: 2026.02.20</span><span>Data by. ê¼¬ë¹„ì•„ë¹ </span></div>
    </div>
    <div class="search-area">
      <div class="search-box"><input type="text" id="petSearch" placeholder="í˜íŠ¸ ì´ë¦„ ê²€ìƒ‰..." autocomplete="off"></div>
    </div>
    <div class="filter-chips" id="chosungTokens"></div>
    <div class="filter-chips" id="chosung"></div>
    <div style="padding: 0 20px 10px; display:flex; gap:10px; align-items:center;">
       <span style="font-size:11px; color:var(--text-sub);">ì¦ê²¨ì°¾ê¸°:</span>
       <div id="favChips" style="display:flex; gap:5px; flex-wrap:wrap;"></div>
    </div>
    <div class="pet-list" id="petList"></div>
  </aside>

  <main class="main-content">
    <nav class="top-nav">
      <div class="nav-controls"><div class="menu-toggle" id="openSidebarBtn">â˜°</div><button class="admin-btn" id="btnAdmin">â˜…</button></div>
    </nav>

    <div class="dashboard">
      <section class="panel notice-panel">
        <div class="notice-header"><div class="notice-title" style="font-weight:700; color:var(--accent)">SYSTEM NOTICE (StoneAge Together)</div></div>
        <div class="notice-content">
          - ì…ë ¥ëœ í˜íŠ¸ ëŠ¥ë ¥ì¹˜ì—ëŠ” ì˜¤íƒ€ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ í˜íŠ¸ ì¡°íšŒ ì‹œ ê²Œì„ ë‚´ ì´ˆê¸°ì¹˜ì™€ ì„±ì¥ë¥ ì„ í™•ì¸í•˜ì„¸ìš”.<br>
          - ìš°ì¸¡ í•˜ë‹¨ <b>PET CATCH MONITOR</b>ë¥¼ í†µí•´ ê°€ë°© ê°€ë“ ì°¸ ì•Œë¦¼ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </section>

      <!-- ì¢Œì¸¡ ì…ë ¥ íŒ¨ë„ -->
      <section class="panel">
        <h2><span id="selectedPetTitle">í˜íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</span></h2>
        <div class="input-group-title">Sê¸‰ ê¸°ì¤€ (ì´ˆê¸°ì¹˜ / ì„±ì¥ë¥ )</div>
        <div class="stat-grid">
          <div class="stat-col"><label>ë‚´êµ¬ë ¥</label><div class="stat-box readonly"><input type="text" id="s0_hp" readonly placeholder="-"></div><div class="stat-box readonly" style="margin-top:6px"><input type="text" id="sg_hp" readonly placeholder="-"></div></div>
          <div class="stat-col"><label>ê³µê²©ë ¥</label><div class="stat-box readonly"><input type="text" id="s0_atk" readonly placeholder="-"></div><div class="stat-box readonly" style="margin-top:6px"><input type="text" id="sg_atk" readonly placeholder="-"></div></div>
          <div class="stat-col"><label>ë°©ì–´ë ¥</label><div class="stat-box readonly"><input type="text" id="s0_def" readonly placeholder="-"></div><div class="stat-box readonly" style="margin-top:6px"><input type="text" id="sg_def" readonly placeholder="-"></div></div>
          <div class="stat-col"><label>ìˆœë°œë ¥</label><div class="stat-box readonly"><input type="text" id="s0_agi" readonly placeholder="-"></div><div class="stat-box readonly" style="margin-top:6px"><input type="text" id="sg_agi" readonly placeholder="-"></div></div>
        </div>

        <div class="input-group-title" style="margin-top:20px; color:var(--accent);">Lv.1 í˜íŠ¸ ëŠ¥ë ¥ì¹˜ ì…ë ¥</div>
        <div class="stat-grid">
          <div class="stat-col"><label>ë‚´êµ¬ë ¥</label><div class="stat-box"><input type="number" id="obs_hp" placeholder="0"></div><div class="stepper-btn" style="display:flex; gap:2px; margin-top:4px"><button class="s-btn" data-target="obs_hp" data-delta="-1">-1</button><button class="s-btn" data-target="obs_hp" data-delta="1">+1</button></div></div>
          <div class="stat-col"><label>ê³µê²©ë ¥</label><div class="stat-box"><input type="number" id="obs_atk" placeholder="0"></div><div class="stepper-btn" style="display:flex; gap:2px; margin-top:4px"><button class="s-btn" data-target="obs_atk" data-delta="-1">-1</button><button class="s-btn" data-target="obs_atk" data-delta="1">+1</button></div></div>
          <div class="stat-col"><label>ë°©ì–´ë ¥</label><div class="stat-box"><input type="number" id="obs_def" placeholder="0"></div><div class="stepper-btn" style="display:flex; gap:2px; margin-top:4px"><button class="s-btn" data-target="obs_def" data-delta="-1">-1</button><button class="s-btn" data-target="obs_def" data-delta="1">+1</button></div></div>
          <div class="stat-col"><label>ìˆœë°œë ¥</label><div class="stat-box"><input type="number" id="obs_agi" placeholder="0"></div><div class="stepper-btn" style="display:flex; gap:2px; margin-top:4px"><button class="s-btn" data-target="obs_agi" data-delta="-1">-1</button><button class="s-btn" data-target="obs_agi" data-delta="1">+1</button></div></div>
        </div>

        <div class="action-btns">
          <button class="btn-main btn-reset" id="btnReset">ë¦¬ì…‹</button>
          <button class="btn-main btn-calc" id="btnCalc">ë¶„ì„ ì‹œì‘</button>
        </div>
      </section>

      <!-- ìš°ì¸¡ ê²°ê³¼ + ì•Œë¦¼ -->
      <div style="display:flex; flex-direction:column; gap:24px;">
        <section class="panel result-panel">
          <h2>ANALYSIS HUD</h2>
          <div class="hud-rings">
            <div class="ring-container">
              <svg class="ring-svg" viewBox="0 0 36 36"><path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/><path id="ringSuccess" class="ring-val" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/></svg>
              <div class="ring-text" id="kpiSuccess">0%</div><span style="font-size:11px; color:var(--text-sub)">8ë“±ê¸‰ í™•ë¥ </span>
            </div>
            <div class="ring-container">
              <svg class="ring-svg" viewBox="0 0 36 36"><path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/><path id="ringTries" class="ring-val" style="stroke:#ffb300" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/></svg>
              <div class="ring-text" id="kpiTries">-</div><span style="font-size:11px; color:var(--text-sub)">ì‹œë„ íšŸìˆ˜</span>
            </div>
          </div>
          <div class="stat-summary">
            <div class="sum-item"><span class="sum-label">ì¶œí˜„ í™•ë¥ </span><span class="sum-val" id="kpiAppear">-</span></div>
            <div class="sum-item"><span class="sum-label">ê²½ìš°ì˜ ìˆ˜</span><span class="sum-val" id="totMatches">-</span></div>
            <div class="sum-item"><span class="sum-label">8ë“±ê¸‰ ë§¤ì¹­</span><span class="sum-val" id="rank8Matches">-</span></div>
          </div>
          <div id="dist" style="margin-top:20px;">
            <div style="text-align:center; color:var(--text-sub); padding:20px;">ë¶„ì„ ê²°ê³¼ ëŒ€ê¸° ì¤‘...</div>
          </div>
        </section>

        <!-- [ì‹ ê·œ] í˜íŠ¸ì¡ì´ ì•Œë¦¼ íŒ¨ë„ -->
        <section class="panel monitor-panel">
          <h2>PET CATCH MONITOR</h2>
          <div class="monitor-status">
            <div id="statusDot" class="status-dot"></div>
            <div id="statusText" style="flex:1;">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
            <div id="monitoredFile" style="font-size:11px; color:var(--accent)"></div>
          </div>
          
          <div class="volume-row">
            <span style="font-size:11px; color:var(--text-sub);">ë³¼ë¥¨</span>
            <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.1" value="0.5">
            <span id="volumeValue" style="font-size:11px; color:var(--accent); min-width:25px; text-align:right;">50%</span>
          </div>

          <div class="log-viewer" id="logViewer">
            <div class="log-line">ë¡œê·¸ í´ë”ë¥¼ ì„ íƒí•˜ë©´ ì‹¤ì‹œê°„ ê°ì‹œê°€ ì‹œì‘ë©ë‹ˆë‹¤.</div>
          </div>
          <div class="monitor-btns">
            <button class="btn-main btn-reset btn-sm" onclick="testAlarm()">ğŸ”Š ì†Œë¦¬ í…ŒìŠ¤íŠ¸</button>
            <button class="btn-main btn-calc btn-sm" id="btnStartMonitor">ğŸ“ í´ë” ì„ íƒ</button>
            <button class="btn-main btn-reset btn-sm" id="btnStopMonitor" style="display:none;">ì¤‘ì§€</button>
          </div>
          <div style="font-size:10px; color:var(--text-sub); margin-top:8px; text-align:right;">
            ê°ì§€ í‚¤ì›Œë“œ: <span style="color:var(--accent)">ê°€ë°© : [0 / 5]</span>
          </div>
        </section>
      </div>
    </div>
  </main>
</div>

<div id="toastWrap"></div>

<!-- ì•Œë¦¼ìŒ ê°ì²´ -->
<audio id="alarmAudio" src="https://raw.githubusercontent.com/kkoby-daddy/kkoby_together/main/sam_02.wav" preload="auto"></audio>

<script>
/* ========= ë°ì´í„° ë° ìœ í‹¸ ========= */
const REMOTE_PETS = `https://raw.githubusercontent.com/kkoby-daddy/kkoby-daddy.github.io/main/kkoby_together/data/pets.json`;
const LS_TABLE = "TogetherPetTable_cache";
const TOTAL = 178750;
const FAV_LS_KEY = "pet_favs_v1";
const VOL_LS_KEY = "monitor_volume";

let GLOBAL_TABLE = {};
let ALL_NAMES = [];
let FAVS = [];

function showToast(msg){
  const wrap = document.getElementById("toastWrap");
  const t = document.createElement("div"); t.className = "toast"; t.textContent = msg;
  wrap.appendChild(t);
  void t.offsetWidth; t.style.opacity = '1';
  setTimeout(()=>{ t.style.opacity = '0'; setTimeout(()=>t.remove(), 300); }, 2000);
}

async function loadGlobalTable(){
  try{
    const obj = await fetch(REMOTE_PETS + `?v=${Date.now()}`).then(r=>r.json());
    GLOBAL_TABLE = obj; localStorage.setItem(LS_TABLE, JSON.stringify(obj));
  }catch{
    GLOBAL_TABLE = JSON.parse(localStorage.getItem(LS_TABLE) || "{}");
  }
  ALL_NAMES = Object.keys(GLOBAL_TABLE).sort((a,b)=>a.localeCompare(b,'ko'));
  FAVS = JSON.parse(localStorage.getItem(FAV_LS_KEY)||"[]").filter(n => GLOBAL_TABLE[n]).slice(0,5);
  renderFavChips();
}

/* ========= í˜íŠ¸ì¡ì´ ì•Œë¦¼ ë¡œì§ ========= */
let dirHandle = null;
let monitorTimer = null;
let currentFile = "";
let lastSize = 0;
const logViewer = document.getElementById('logViewer');
const alarmAudio = document.getElementById('alarmAudio');
const volumeSlider = document.getElementById('volumeSlider');
const volumeValue = document.getElementById('volumeValue');

// ë³¼ë¥¨ ì´ˆê¸°í™”
(function initVolume(){
  const savedVol = localStorage.getItem(VOL_LS_KEY) || 0.5;
  alarmAudio.volume = savedVol;
  volumeSlider.value = savedVol;
  volumeValue.textContent = Math.round(savedVol * 100) + "%";
  
  volumeSlider.oninput = (e) => {
    const val = e.target.value;
    alarmAudio.volume = val;
    volumeValue.textContent = Math.round(val * 100) + "%";
    localStorage.setItem(VOL_LS_KEY, val);
  };
})();

function addLog(msg, isAlert = false) {
  const line = document.createElement('div');
  line.className = 'log-line' + (isAlert ? ' alert' : '');
  const time = new Date().toLocaleTimeString('ko-KR', { hour12: false });
  line.textContent = `[${time}] ${msg}`;
  logViewer.appendChild(line);
  logViewer.scrollTop = logViewer.scrollHeight;
  if(logViewer.childElementCount > 50) logViewer.removeChild(logViewer.firstChild);

  if(msg.includes("ê°€ë°© : [0 / 5]")) {
    playAlarm();
    line.classList.add('alert');
  }
}

function playAlarm() {
  alarmAudio.currentTime = 0;
  alarmAudio.play().catch(e => console.warn("ìë™ ì¬ìƒ ì°¨ë‹¨ë¨: ë¸Œë¼ìš°ì €ì—ì„œ 'ì†Œë¦¬ í—ˆìš©'ì´ í•„ìš”í•©ë‹ˆë‹¤."));
}

function testAlarm() { playAlarm(); showToast("ì•Œë¦¼ìŒ í…ŒìŠ¤íŠ¸ ì¬ìƒ!"); }

document.getElementById('btnStartMonitor').onclick = async () => {
  try {
    dirHandle = await window.showDirectoryPicker();
    document.getElementById('btnStartMonitor').style.display = 'none';
    document.getElementById('btnStopMonitor').style.display = 'inline-block';
    document.getElementById('statusDot').classList.add('active');
    document.getElementById('statusText').textContent = "ì‹¤ì‹œê°„ ê°ì‹œ ì¤‘";
    addLog("í´ë” ì—°ê²° ì„±ê³µ. ê°ì‹œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.", false);
    
    monitorTimer = setInterval(watchLogs, 2000);
  } catch (err) {
    if (err.name !== 'AbortError') showToast("í´ë” ì„ íƒ ì˜¤ë¥˜!");
  }
};

document.getElementById('btnStopMonitor').onclick = () => {
  clearInterval(monitorTimer);
  document.getElementById('btnStartMonitor').style.display = 'inline-block';
  document.getElementById('btnStopMonitor').style.display = 'none';
  document.getElementById('statusDot').classList.remove('active');
  document.getElementById('statusText').textContent = "ì¤‘ì§€ë¨";
  addLog("ëª¨ë‹ˆí„°ë§ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
};

async function watchLogs() {
  try {
    let latest = null; let latestMtime = 0;
    for await (const entry of dirHandle.values()) {
      if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
        const file = await entry.getFile();
        if (file.lastModified > latestMtime) { latestMtime = file.lastModified; latest = entry; }
      }
    }
    if (!latest) return;
    const file = await latest.getFile();
    if (latest.name !== currentFile) {
      currentFile = latest.name; lastSize = file.size;
      document.getElementById('monitoredFile').textContent = currentFile;
      addLog(`ìƒˆ íŒŒì¼ ê°ì§€: ${currentFile}`);
    } else if (file.size > lastSize) {
      const slice = file.slice(lastSize);
      const text = await slice.text();
      const lines = text.split('\n').filter(l => l.trim());
      lines.forEach(l => addLog(l.trim()));
      lastSize = file.size;
    }
  } catch(e) { console.error(e); }
}

/* ========= ê¸°ì¡´ ë¶„ì„ê¸° ë¡œì§ ========= */
const CHO_CODE = ['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
const CHO_SIMPLE = (c)=>({"ã„²":"ã„±","ã„¸":"ã„·","ã…ƒ":"ã…‚","ã…†":"ã……","ã…‰":"ã…ˆ"}[c]||c);
function getChosung(str){
  let out=""; for(const ch of str){
    const code = ch.charCodeAt(0); if(code<0xAC00 || code>0xD7A3){ out+=ch; continue; }
    out += CHO_SIMPLE(CHO_CODE[Math.floor((code-0xAC00)/588)]);
  } return out;
}

const petListEl = document.getElementById('petList');
const searchInput = document.getElementById('petSearch');
let currentChosung = ""; let selectedName = null;

function renderPetList() {
  const kw = searchInput.value.trim();
  const list = ALL_NAMES.filter(n => (kw ? n.includes(kw) : true) && (currentChosung ? getChosung(n).startsWith(currentChosung) : true));
  petListEl.innerHTML = list.length ? "" : '<div style="color:var(--text-sub); text-align:center; padding:20px;">ê²°ê³¼ ì—†ìŒ</div>';
  list.forEach(n => {
    const item = document.createElement('div'); item.className = 'pet-item' + (selectedName===n?' selected':'');
    item.innerHTML = `<span class="pet-name">${n}</span><div class="pet-right"><span class="fav-icon ${FAVS.includes(n)?'active':''}">â˜…</span></div>`;
    item.onclick = () => { selectedName=n; updateInputPanel(); closeSidebar(); renderPetList(); };
    petListEl.appendChild(item);
  });
}

function updateInputPanel() {
  const p = GLOBAL_TABLE[selectedName];
  document.getElementById('selectedPetTitle').textContent = selectedName;
  ['hp','atk','def','agi'].forEach(k => {
    document.getElementById(`s0_${k}`).value = p.s0[k].toFixed(2);
    document.getElementById(`sg_${k}`).value = p.sg[k].toFixed(2);
    document.getElementById(`obs_${k}`).value = Math.floor(p.s0[k]);
  });
}

document.getElementById('btnCalc').onclick = () => {
  if(!selectedName) return showToast("í˜íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");
  const obs = ['hp','atk','def','agi'].map(k => parseInt(document.getElementById(`obs_${k}`).value));
  const p = GLOBAL_TABLE[selectedName];
  setTimeout(() => {
    const res = runEnumerate(p, obs);
    renderResult(res);
  }, 10);
};

function runEnumerate(pku, obs) {
    const k = new Decimal(pku.k), fac = k.dividedBy(100), u = pku.u;
    let matches = 0, rank8 = 0, dist = {};
    for(let ar=-2; ar<=2; ar++) for(let dr=-2; dr<=2; dr++) for(let gr=-2; gr<=2; gr++) for(let hr=-2; hr<=2; hr++){
      for(let ab=0; ab<=10; ab++) for(let db=0; db<=10; db++) for(let gb=0; gb<=10; gb++){
        const hb = 10 - ab - db - gb; if(hb < 0 || hb > 10) continue;
        const iH = new Decimal(u.hp+hr+hb).times(fac), iA = new Decimal(u.atk+ar+ab).times(fac), iD = new Decimal(u.def+dr+db).times(fac), iG = new Decimal(u.agi+gr+gb).times(fac);
        if(iG.floor().toNumber() !== obs[3]) continue;
        if(iH.times(4).plus(iA).plus(iD).plus(iG).floor().toNumber() !== obs[0]) continue;
        if(iH.times(0.1).plus(iA).plus(iD.times(0.1)).plus(iG.times(0.05)).floor().toNumber() !== obs[1]) continue;
        if(iH.times(0.1).plus(iA.times(0.1)).plus(iD).plus(iG.times(0.05)).floor().toNumber() !== obs[2]) continue;
        matches++; const r = ar+dr+gr+hr; dist[r] = (dist[r]||0)+1; if(r===8) rank8++;
      }
    }
    return {matches, rank8, dist};
}

function renderResult(res) {
  const pct = res.matches ? (res.rank8/res.matches*100) : 0;
  document.getElementById('ringSuccess').style.strokeDasharray = `${pct}, 100`;
  document.getElementById('kpiSuccess').textContent = pct.toFixed(2) + "%";
  document.getElementById('totMatches').textContent = res.matches.toLocaleString();
  document.getElementById('rank8Matches').textContent = res.rank8.toLocaleString();
  document.getElementById('kpiAppear').textContent = (res.matches/TOTAL*100).toFixed(4) + "%";
  
  let html = `<div class="rank8-card"><div style="color:var(--ok); font-weight:700;">8ë“±ê¸‰ (MAX)</div><div>${res.rank8.toLocaleString()}ê°œ</div></div>`;
  html += `<table class="detail-table"><thead><tr><th>ë“±ê¸‰</th><th>ê°œìˆ˜</th><th>í™•ë¥ </th></tr></thead><tbody>`;
  Object.entries(res.dist).sort((a,b)=>b[0]-a[0]).forEach(([r,c])=>{
    if(r==8) return;
    html += `<tr><td>${r}ë“±ê¸‰</td><td>${c.toLocaleString()}</td><td>${(c/res.matches*100).toFixed(1)}%</td></tr>`;
  });
  html += `</tbody></table>`;
  document.getElementById('dist').innerHTML = html;
}

function renderFavChips(){
  const box = document.getElementById('favChips'); box.innerHTML = "";
  FAVS.forEach(n => {
    const c = document.createElement('div'); c.className = 'chip active'; c.textContent = n;
    c.onclick = () => { selectedName=n; updateInputPanel(); renderPetList(); };
    box.appendChild(c);
  });
}

['ã„±','ã„´','ã„·','ã„¹','ã…','ã…‚','ã……','ã…‡','ã…ˆ','ã…Š','ã…‹','ã…Œ','ã…','ã…'].forEach(c => {
  const chip = document.createElement('div'); chip.className = 'chip'; chip.textContent = c;
  chip.onclick = () => { currentChosung = currentChosung === c ? "" : c; renderPetList(); };
  document.getElementById('chosung').appendChild(chip);
});

const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('sidebarOverlay');
function openSidebar() { sidebar.classList.add('active'); overlay.classList.add('active'); }
function closeSidebar() { sidebar.classList.remove('active'); overlay.classList.remove('active'); }
document.getElementById('openSidebarBtn').onclick = openSidebar;
document.getElementById('closeSidebarBtn').onclick = closeSidebar;
overlay.onclick = closeSidebar;

searchInput.oninput = renderPetList;
document.getElementById('btnReset').onclick = () => location.reload();

(async function init(){
  await loadGlobalTable();
  renderPetList();
})();
</script>
</body>
</html>
